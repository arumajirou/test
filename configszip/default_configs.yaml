# ============================================================================
# NeuralForecast 自動最適化システム デフォルト設定
# ============================================================================
# このファイルはシステム全体のデフォルト設定を一元管理します。
# ユーザーはこれらの設定を上書きすることができます。
#
# 主要セクション:
#   1. experiment_tracking: 実験追跡（MLflow）設定
#   2. hyperparameter_optimization: ハイパーパラメータ最適化設定
#   3. distributed_computing: 分散計算（Ray）設定
#   4. validation: 検証設定
#   5. logging: ロギング設定
#   6. model_training: モデル訓練設定
#   7. search_algorithm: 探索アルゴリズム設定
# ============================================================================

# ====================
# 1. 実験追跡設定 (MLflow)
# ====================
experiment_tracking:
  enabled: true
  tracking_uri: null  # nullの場合、ローカルファイルシステムを使用
  experiment_name: "neuralforecast_optimization"
  artifact_location: null  # nullの場合、デフォルトのartifactディレクトリを使用
  
  # 自動ロギング設定
  auto_logging:
    enabled: true
    log_models: true
    log_input_examples: true
    log_model_signatures: true
    log_datasets: false  # 大規模データセットの場合はfalseを推奨
  
  # メトリクス設定
  metrics:
    primary_metric: "val_loss"
    additional_metrics:
      - "train_loss"
      - "learning_rate"
      - "epoch"
  
  # タグ設定
  tags:
    framework: "NeuralForecast"
    optimization_backend: "optuna"  # または "ray"
    version: "1.0.0"

# ====================
# 2. ハイパーパラメータ最適化設定
# ====================
hyperparameter_optimization:
  # バックエンド設定
  backend: "optuna"  # "optuna" or "ray"
  
  # 試行回数（nullの場合は自動推奨）
  num_samples: null
  
  # 最適化方向
  optimization_direction: "minimize"  # "minimize" or "maximize"
  
  # プルーニング設定
  pruning:
    enabled: true
    patience: 10  # 改善が見られない場合の待機ステップ数
  
  # 早期停止設定
  early_stopping:
    enabled: true
    patience: 20
    min_delta: 0.0001  # 改善とみなす最小変化量
  
  # Optunaバックエンド固有設定
  optuna:
    sampler:
      default: "TPESampler"  # TPESampler/RandomSampler/CmaEsSampler/GridSampler
      n_startup_trials: 10
      multivariate: true
      seed: null
    
    pruner:
      default: "MedianPruner"  # MedianPruner/HyperbandPruner/PercentilePruner
      n_warmup_steps: 10
      n_min_trials: 5
    
    study:
      storage: null  # nullの場合、インメモリストレージを使用
      load_if_exists: true
  
  # Ray Tuneバックエンド固有設定
  ray:
    search_alg:
      default: "OptunaSearch"  # OptunaSearch/BayesOptSearch/HyperOptSearch
      mode: "min"
    
    scheduler:
      default: "ASHAScheduler"  # ASHAScheduler/HyperBandScheduler/MedianStoppingRule
      max_t: 100
      grace_period: 10
      reduction_factor: 3
    
    tune_config:
      metric: "val_loss"
      mode: "min"
      num_samples: null

# ====================
# 3. 分散計算設定 (Ray)
# ====================
distributed_computing:
  # リソース設定
  resources:
    cpus_per_trial: 4
    gpus_per_trial: 1
    memory_per_trial_gb: 16
  
  # 並列実行設定
  concurrent_trials: 4  # 同時実行する試行数
  
  # Ray初期化設定
  ray_init:
    num_cpus: null  # nullの場合、全CPUを使用
    num_gpus: null  # nullの場合、全GPUを使用
    ignore_reinit_error: true
    include_dashboard: true
  
  # クラスタ設定（分散実行時）
  cluster:
    enabled: false
    address: null  # Rayクラスタのアドレス
    redis_password: null

# ====================
# 4. 検証設定
# ====================
validation:
  # 検証モード
  strict_mode: false  # trueの場合、警告もエラーとして扱う
  
  # 環境検証
  environment:
    check_gpu: true
    check_memory: true
    check_disk_space: true
    min_memory_gb: 8
    min_disk_space_gb: 10
  
  # データ検証
  dataset:
    check_missing_values: true
    check_duplicates: true
    check_time_series_continuity: true
    min_series_length: 50
    max_missing_ratio: 0.1  # 10%まで欠損値を許容
  
  # 設定検証
  config:
    check_parameter_ranges: true
    check_compatibility: true
    auto_correct: true  # 自動修正を試みる

# ====================
# 5. ロギング設定
# ====================
logging:
  # ログレベル
  level: "INFO"  # DEBUG/INFO/WARNING/ERROR/CRITICAL
  
  # ログ出力先
  handlers:
    console:
      enabled: true
      level: "INFO"
    
    file:
      enabled: true
      level: "DEBUG"
      filename: "neuralforecast_optimization.log"
      max_bytes: 10485760  # 10MB
      backup_count: 5
  
  # ログフォーマット
  format:
    standard: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    detailed: "%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s"
  
  # 構造化ログ（JSON）
  structured:
    enabled: true
    include_timestamp: true
    include_context: true

# ====================
# 6. モデル訓練設定
# ====================
model_training:
  # 一般的な訓練設定
  common:
    max_steps: 1000
    learning_rate: 0.001
    batch_size: 32
    val_check_steps: 100
    early_stop_patience_steps: -1  # -1は無効
  
  # 学習率スケジューラー
  lr_scheduler:
    enabled: false
    type: "ReduceLROnPlateau"  # ReduceLROnPlateau/StepLR/CosineAnnealingLR
    patience: 5
    factor: 0.5
    min_lr: 1e-6
  
  # オプティマイザー
  optimizer:
    type: "Adam"  # Adam/AdamW/SGD
    weight_decay: 0.0
    betas: [0.9, 0.999]
    eps: 1e-8
  
  # データローダー
  dataloader:
    num_workers: 4
    pin_memory: true
    drop_last: false
    shuffle: true
  
  # 勾配クリッピング
  gradient_clipping:
    enabled: true
    max_norm: 1.0
    norm_type: 2.0

# ====================
# 7. 探索アルゴリズム設定
# ====================
search_algorithm:
  # 試行回数推奨設定
  num_samples_recommendation:
    simple_model:
      small_data: 20
      medium_data: 30
      large_data: 50
    
    moderate_model:
      small_data: 30
      medium_data: 50
      large_data: 100
    
    complex_model:
      small_data: 50
      medium_data: 100
      large_data: 200
  
  # データセットサイズ閾値
  dataset_size_thresholds:
    small: 1000      # < 1000行
    medium: 100000   # 1000-100000行
    # large: > 100000行
  
  # 探索空間複雑度閾値
  search_space_complexity:
    low_param_count: 5      # < 5パラメータ
    high_param_count: 15    # > 15パラメータ
  
  # アルゴリズム選択マトリックス
  algorithm_selection:
    # 小規模データセット
    small_data:
      simple_model: "RandomSampler"
      moderate_model: "TPESampler"
      complex_model: "TPESampler"
    
    # 中規模データセット
    medium_data:
      simple_model: "TPESampler"
      moderate_model: "TPESampler"
      complex_model: "CmaEsSampler"
    
    # 大規模データセット
    large_data:
      simple_model: "TPESampler"
      moderate_model: "CmaEsSampler"
      complex_model: "TPESampler_multivariate"
  
  # プルーニング戦略
  pruning_strategy:
    small_data:
      pruner: "MedianPruner"
      n_warmup_steps: 20
      aggressive: false
    
    medium_data:
      pruner: "MedianPruner"
      n_warmup_steps: 10
      aggressive: false
    
    large_data:
      pruner: "HyperbandPruner"
      min_resource: 5
      reduction_factor: 3
      aggressive: true

# ====================
# 8. デフォルトハイパーパラメータ探索空間
# ====================
default_hyperparameter_space:
  # 共通パラメータ
  common:
    max_steps:
      type: "choice"
      values: [500, 1000, 2000, 3000]
    
    learning_rate:
      type: "loguniform"
      low: 1e-5
      high: 1e-2
    
    batch_size:
      type: "choice"
      values: [16, 32, 64, 128, 256]
    
    input_size:
      type: "choice"
      values: [7, 14, 24, 48, 96]
  
  # Transformer系
  transformer:
    n_heads:
      type: "choice"
      values: [2, 4, 8]
    
    hidden_size:
      type: "choice"
      values: [64, 128, 256, 512]
    
    n_encoder_layers:
      type: "choice"
      values: [1, 2, 3]
    
    dropout:
      type: "uniform"
      low: 0.0
      high: 0.3
  
  # RNN系
  rnn:
    hidden_size:
      type: "choice"
      values: [32, 64, 128, 256]
    
    num_layers:
      type: "choice"
      values: [1, 2, 3]
    
    dropout:
      type: "uniform"
      low: 0.0
      high: 0.3
  
  # NBEATS系
  nbeats:
    n_blocks:
      type: "choice"
      values: [[1, 1, 1], [2, 2, 2], [3, 3, 3]]
    
    n_hidden:
      type: "choice"
      values: [[256, 256], [512, 512], [1024, 1024]]
    
    stack_types:
      type: "categorical"
      values: [["trend", "seasonality"], ["identity", "identity", "identity"]]

# ====================
# 9. パフォーマンス設定
# ====================
performance:
  # キャッシュ設定
  cache:
    enabled: true
    max_size_gb: 10
    ttl_hours: 24
  
  # メモリ管理
  memory:
    clear_cache_between_trials: true
    gc_collection_frequency: 10  # 10試行ごとにガベージコレクション
  
  # チェックポイント
  checkpoint:
    enabled: true
    save_frequency: 10  # 10試行ごとに保存
    keep_n_best: 3
    save_full_state: false

# ====================
# 10. セキュリティ設定
# ====================
security:
  # データプライバシー
  data_privacy:
    anonymize_logs: false
    mask_sensitive_params: false
  
  # MLflowセキュリティ
  mlflow:
    use_authentication: false
    certificate_path: null

# ====================
# 11. デバッグ設定
# ====================
debug:
  # デバッグモード
  enabled: false
  
  # プロファイリング
  profiling:
    enabled: false
    output_dir: "./profiling_results"
  
  # 詳細ログ
  verbose:
    level: 1  # 0: 最小, 1: 標準, 2: 詳細, 3: 最大
    print_trial_results: true
    print_config: true
    print_progress: true
  
  # トレースバック
  traceback:
    full: true
    limit: null  # nullの場合、制限なし

# ====================
# 12. システム設定
# ====================
system:
  # 乱数シード
  random_seed: 42
  
  # タイムゾーン
  timezone: "UTC"
  
  # 一時ディレクトリ
  temp_dir: "/tmp/neuralforecast_optimization"
  
  # 出力ディレクトリ
  output_dir: "./outputs"
  
  # バージョン情報
  version: "1.0.0"
  config_schema_version: "1.0"
